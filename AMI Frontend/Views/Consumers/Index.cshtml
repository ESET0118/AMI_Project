@{
    ViewBag.Title = "Consumers";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.14.0-beta3/dist/css/bootstrap-select.min.css">

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.14.0-beta3/dist/js/bootstrap-select.min.js"></script>

<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h4 class="fw-bold text-dark">🏠 Consumers</h4>
        <div>
            <button id="addConsumerBtn" class="btn btn-primary btn-sm shadow-glow me-2">
                <i class="bi bi-plus-circle"></i> Add Consumer
            </button>
            <button id="refreshConsumers" class="btn btn-success btn-sm shadow-glow">
                <i class="bi bi-arrow-clockwise"></i> Refresh
            </button>
        </div>
    </div>

    <div class="card shadow-lg border-0 rounded-4 glass-card">
        <div class="card-body">
            <table class="table table-hover align-middle">
                <thead class="table-light">
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Phone</th>
                        <th>Org Unit</th>
                        <th>Tariff</th>
                        <th class="text-center">Actions</th>
                    </tr>
                </thead>
                <tbody id="consumerTableBody">
                    <tr><td colspan="7" class="text-center text-muted py-4">Loading consumers...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Add/Edit Modal -->
<div class="modal fade" id="consumerModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg modal-dialog-scrollable">
        <div class="modal-content border-0 rounded-5 shadow-glow animate__animated animate__fadeInUp">
            <div class="modal-header text-white border-0"
                 style="background: linear-gradient(135deg, #0078ff, #00d084);">
                <h5 class="modal-title fw-bold" id="consumerModalTitle"></h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body p-4 bg-light bg-gradient">
                <form id="consumerForm">
                    <input type="hidden" id="consumerId">

                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Full Name</label>
                            <div class="input-group">
                                <span class="input-group-text bg-white"><i class="bi bi-person"></i></span>
                                <input type="text" class="form-control" id="consumerName" required>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Email</label>
                            <div class="input-group">
                                <span class="input-group-text bg-white"><i class="bi bi-envelope"></i></span>
                                <input type="email" class="form-control" id="consumerEmail">
                            </div>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Phone</label>
                            <div class="input-group">
                                <span class="input-group-text bg-white"><i class="bi bi-telephone"></i></span>
                                <input type="text" class="form-control" id="consumerPhone">
                            </div>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Address</label>
                            <div class="input-group">
                                <span class="input-group-text bg-white"><i class="bi bi-geo-alt"></i></span>
                                <input type="text" class="form-control" id="consumerAddress">
                            </div>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Org Unit</label>
                            <select class="selectpicker form-control" id="orgUnitSelect" data-live-search="true" title="Select Org Unit" required></select>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Tariff</label>
                            <select class="selectpicker form-control" id="tariffSelect" required>
                                <option value="1">Domestic Tariff</option>
                                <option value="2">Industrial Tariff</option>
                                <option value="3">Commercial Tariff</option>
                            </select>
                        </div>
                    </div>

                    <div class="text-end mt-4">
                        <button type="submit" class="btn btn-primary px-4 py-2 rounded-4 shadow-glow">
                            <i class="bi bi-check-circle me-1"></i> Save
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Toast Notification -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 2000">
    <div id="toast" class="toast align-items-center text-white bg-success border-0 shadow-lg" role="alert">
        <div class="d-flex">
            <div class="toast-body fw-semibold"></div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    </div>
</div>

<script>
    const apiBase = "https://localhost:7199/api";

    function showToast(message, isError = false) {
        const toast = $("#toast");
        toast.removeClass("bg-success bg-danger")
             .addClass(isError ? "bg-danger" : "bg-success")
             .find(".toast-body").text(message);
        new bootstrap.Toast(toast[0]).show();
    }

    // Initialize Selectpickers
    $('#tariffSelect').selectpicker({ dropupAuto: false, container: '#consumerModal' });
    $('#orgUnitSelect').selectpicker({ dropupAuto: false, container: '#consumerModal' });

    // Load Org Units dynamically
    function loadOrgUnits(callback) {
        $.get(`${apiBase}/orgunit`, d => {
            $("#orgUnitSelect").empty();
            d.forEach(o => $("#orgUnitSelect").append(`<option value="${o.orgUnitId}">${o.name}</option>`));
            $('#orgUnitSelect').selectpicker('refresh');
            if(callback) callback();
        });
    }

    // Load consumers
    function loadConsumers() {
        $("#consumerTableBody").html("<tr><td colspan='7' class='text-center text-muted py-4'>Loading...</td></tr>");
        $.ajax({
            url: `${apiBase}/consumer`,
            headers: { "Authorization": "Bearer " + localStorage.getItem("jwtToken") },
            success: function (data) {
                let rows = "";
                data.forEach(c => {
                    rows += `
                        <tr>
                            <td>${c.consumerId}</td>
                            <td>${c.name}</td>
                            <td>${c.email || '-'}</td>
                            <td>${c.phone || '-'}</td>
                            <td>${c.orgUnitName || '-'}</td>
                            <td>${c.tariffName || '-'}</td>
                            <td class="text-center">
                                <button class="btn btn-sm btn-outline-primary me-2" onclick="openEditModal(${c.consumerId})">
                                    <i class="bi bi-pencil-square"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteConsumer(${c.consumerId})">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </td>
                        </tr>`;
                });
                $("#consumerTableBody").html(rows || "<tr><td colspan='7' class='text-center text-muted py-4'>No consumers found.</td></tr>");
            },
            error: () => $("#consumerTableBody").html("<tr><td colspan='7' class='text-center text-danger py-4'>Failed to load consumers.</td></tr>")
        });
    }

    // Open modal for adding consumer
    $("#addConsumerBtn").click(() => {
        $("#consumerForm")[0].reset();
        $("#consumerId").val("");
        $("#consumerModalTitle").text("➕ Add New Consumer");
        loadOrgUnits();
        $('#tariffSelect').selectpicker('refresh');
        $("#consumerModal").modal("show");
    });

    // Open modal for editing
    function openEditModal(id) {
        $.ajax({
            url: `${apiBase}/consumer/${id}`,
            headers: { "Authorization": "Bearer " + localStorage.getItem("jwtToken") },
            success: function(c) {
                $("#consumerId").val(c.consumerId);
                $("#consumerName").val(c.name);
                $("#consumerEmail").val(c.email);
                $("#consumerPhone").val(c.phone);
                $("#consumerAddress").val(c.address);

                loadOrgUnits(() => {
                    $('#orgUnitSelect').selectpicker('val', c.orgUnitId);
                    $('#tariffSelect').selectpicker('val', c.tariffId);
                });

                $("#consumerModalTitle").text("✏️ Edit Consumer");
                $("#consumerModal").modal("show");
            }
        });
    }

    // Submit form
    $("#consumerForm").on("submit", function(e) {
        e.preventDefault();
        const id = $("#consumerId").val();
        const dto = {
            name: $("#consumerName").val(),
            email: $("#consumerEmail").val(),
            phone: $("#consumerPhone").val(),
            address: $("#consumerAddress").val(),
            orgUnitId: parseInt($("#orgUnitSelect").val()),
            tariffId: parseInt($("#tariffSelect").val())
        };
        const method = id ? "PUT" : "POST";
        const url = id ? `${apiBase}/consumer/${id}` : `${apiBase}/consumer`;

        $.ajax({
            url, method,
            headers: { "Authorization": "Bearer " + localStorage.getItem("jwtToken") },
            contentType: "application/json",
            data: JSON.stringify(dto),
            success: function () {
                $("#consumerModal").modal("hide");
                showToast(id ? "Consumer updated!" : "Consumer added!");
                loadConsumers();
            },
            error: () => showToast("❌ Operation failed!", true)
        });
    });

    // Delete consumer
    function deleteConsumer(id) {
        if (!confirm("Are you sure you want to delete this consumer?")) return;
        $.ajax({
            url: `${apiBase}/consumer/${id}`,
            method: "DELETE",
            headers: { "Authorization": "Bearer " + localStorage.getItem("jwtToken") },
            success: function () {
                showToast("Consumer deleted!");
                loadConsumers();
            },
            error: () => showToast("❌ Delete failed.", true)
        });
    }

    // On page load
    $(document).ready(function () {
        const token = localStorage.getItem("jwtToken");
        if (!token) return window.location.href = "/Account/Login";

        loadConsumers();
        $("#refreshConsumers").click(loadConsumers);
    });
</script>

<style>
    body {
        background: linear-gradient(120deg, #f0f8ff, #e8f9f2);
        font-family: "Inter", sans-serif;
    }

    .glass-card {
        backdrop-filter: blur(10px);
        background: rgba(255, 255, 255, 0.8);
    }

    .shadow-glow {
        box-shadow: 0 4px 15px rgba(0, 200, 255, 0.3);
        transition: all 0.2s ease-in-out;
    }

        .shadow-glow:hover {
            transform: translateY(-2px);
        }

    .input-group-text {
        border-right: 0;
        color: #00a6b2;
    }

    input.form-control:focus, .bootstrap-select .dropdown-toggle:focus {
        border-color: #00a6b2;
        box-shadow: 0 0 0 0.2rem rgba(0,174,255,0.25);
    }

    .btn-primary {
        background: linear-gradient(90deg, #0078ff, #00d084);
        border: none;
    }

        .btn-primary:hover {
            background: linear-gradient(90deg, #00d084, #0078ff);
        }

    .bootstrap-select .dropdown-menu {
        z-index: 2000 !important;
    }
</style>
