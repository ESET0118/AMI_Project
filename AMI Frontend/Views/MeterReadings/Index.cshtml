@{
    ViewBag.Title = "Meter Readings";
    Layout = "~/Views/Shared/_Layout.cshtml";

    string serialNo = ViewBag.SerialNo ?? "";
}

<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">

<style>
    /* Buttons */
    .btn-gradient {
        background: linear-gradient(135deg, #6a11cb, #2575fc);
        color: #fff;
        border: none;
        font-weight: 600;
        transition: 0.3s;
    }

        .btn-gradient:hover {
            background: linear-gradient(135deg, #2575fc, #6a11cb);
            color: #fff;
        }

    .btn-save {
        background: linear-gradient(135deg, #28a745, #1e7e34);
        color: #fff;
        border: none;
        font-weight: 600;
        transition: 0.2s;
    }

        .btn-save:hover {
            background: linear-gradient(135deg, #1e7e34, #28a745);
        }

    /* Calendar title & summary */
    #calendarTitle {
        font-weight: 700;
        font-size: 1.6rem;
    }

    #monthlySummary {
        font-size: 1rem;
        color: #555;
    }

    /* Picker container */
    .picker-container {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        align-items: center;
    }

        .picker-container > div {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            min-width: 180px;
        }

    /* Month name display */
    #monthNameDisplay h3 {
        font-size: 2rem;
        font-weight: 700;
        text-align: center;
        margin-bottom: 0.5rem;
    }

    /* Table inputs */
    table input.form-control-sm {
        min-width: 80px;
        text-align: center;
    }
</style>

<div class="container py-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap">
        <h4 class="fw-bold text-primary"><i class="bi bi-bar-chart-line"></i> Meter Readings</h4>
        <a class="btn btn-outline-secondary btn-sm" href="javascript:history.back()">
            <i class="bi bi-arrow-left"></i> Back
        </a>
    </div>

    <!-- Meter & Month Picker -->
    <div class="card mb-4 shadow-sm">
        <div class="card-body picker-container">
            <div style="flex:1 1 200px;">
                <label class="mb-0 fw-semibold">Meter Serial:</label>
                <input type="text" class="form-control" value="@serialNo" readonly />
            </div>
            <div style="flex:1 1 120px;">
                <label class="mb-0 fw-semibold">Year:</label>
                <input type="number" id="year" class="form-control" />
            </div>
            <div style="flex:1 1 120px;">
                <label class="mb-0 fw-semibold">Month:</label>
                <select id="month" class="form-select">
                    @for (int i = 1; i <= 12; i++)
                    {
                        <option value="@i">@i</option>
                    }
                </select>
            </div>
        </div>
    </div>

    <!-- Month Name Display -->
    <div id="monthNameDisplay" class="mb-3">
        <h3></h3>
    </div>

    <!-- Calendar Table -->
    <div id="calendarContainer" class="card d-none shadow-sm">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2 flex-wrap">
                <h5 id="calendarTitle" class="mb-0"></h5>
                <div class="d-flex gap-2">
                    <button id="bulkSaveBtn" class="btn btn-save"><i class="bi bi-save"></i> Save All</button>
                    <button id="generateBillBtn" class="btn btn-gradient"><i class="bi bi-receipt"></i> Generate Bill</button>
                </div>
            </div>

            <div id="monthlySummary" class="mb-3"></div>

            <div class="table-responsive">
                <table class="table table-bordered table-hover table-sm align-middle text-center">
                    <thead class="table-light">
                        <tr>
                            <th>Day</th>
                            <th>Consumption (kWh)</th>
                            <th>Voltage</th>
                            <th>Ampere</th>
                            <th>Power Factor</th>
                            <th>Frequency</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="calendarBody"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    const apiMeterReadingsBase = "https://localhost:7199/api/meterreading";
    const meterSerialNo = "@serialNo";

    $(function () {
        if(!meterSerialNo){ alert("No meter selected!"); return; }

        const now = new Date();
        $("#year").val(now.getUTCFullYear());
        $("#month").val(now.getUTCMonth() + 1);

        updateMonthName();

        loadCalendar();

        // Reload automatically on month/year change
        $("#month, #year").change(function(){
            updateMonthName();
            loadCalendar();
        });

        $("#bulkSaveBtn").click(bulkSave);
        $("#generateBillBtn").click(generateBill);
    });

    function updateMonthName(){
        const monthIndex = parseInt($("#month").val()) - 1;
        const monthName = new Date(0, monthIndex).toLocaleString('en-US', { month: 'long' });
        $("#monthNameDisplay h3").text(monthName);
    }

    function loadCalendar() {
        const year = parseInt($("#year").val());
        const month = parseInt($("#month").val());

        $("#calendarContainer").addClass("d-none");
        $("#calendarBody").html("<tr><td colspan='7'>Loading...</td></tr>");

        $.get(`${apiMeterReadingsBase}/meter/${encodeURIComponent(meterSerialNo)}/calendar?year=${year}&month=${month}`)
        .done(data => {
            $("#calendarContainer").removeClass("d-none");
            $("#calendarTitle").text(`${data.meterSerialNo} — ${data.month}/${data.year}`);
            $("#monthlySummary").text(`Monthly total: ${data.monthlyTotalKwh ?? 0} kWh — Monthly record exists: ${data.hasMonthlyRecord}`);
            renderCalendar(data.days);
        })
        .fail(err => {
            console.error(err);
            $("#calendarBody").html("<tr><td colspan='7' class='text-danger'>Error loading calendar.</td></tr>");
        });
    }

    function renderCalendar(days){
        if(!days || days.length === 0){
            $("#calendarBody").html("<tr><td colspan='7'>No readings found.</td></tr>");
            return;
        }

        const rows = days.map(d => {
            const dt = new Date(d.date);
            const dayNo = dt.getUTCDate();
            const weekDay = dt.toLocaleString('en-US', { weekday: 'short', timeZone: 'UTC' });

            const consumption = d.consumptionKwh ?? "";
            const voltage = d.voltage ?? "";
            const ampere = d.ampere ?? "";
            const pf = d.powerFactor ?? "";
            const freq = d.frequency ?? "";

            return `<tr data-date="${d.date}">
                <td>${dayNo} <small>${weekDay}</small></td>
                <td><input class="form-control form-control-sm consumption" value="${consumption}" /></td>
                <td><input class="form-control form-control-sm voltage" value="${voltage}" /></td>
                <td><input class="form-control form-control-sm ampere" value="${ampere}" /></td>
                <td><input class="form-control form-control-sm pf" value="${pf}" /></td>
                <td><input class="form-control form-control-sm freq" value="${freq}" /></td>
                <td><button class="btn btn-save btn-sm save-day"><i class="bi bi-save"></i> Save</button></td>
            </tr>`;
        }).join("");

        $("#calendarBody").html(rows);

        $(".save-day").off("click").on("click", function(){
            const $tr = $(this).closest("tr");
            saveSingleDay($tr);
        });
    }

    function collectRowsData($tr = null){
        const year = parseInt($("#year").val());
        const month = parseInt($("#month").val());
        const readings = [];

        const $rows = $tr ? $tr : $("#calendarBody tr");

        $rows.each(function(){
            const date = $(this).data("date");
            const consumption = parseFloatOrNull($(this).find(".consumption").val());
            if(isNaN(consumption)) return;

            readings.push({
                date,
                consumptionKwh: consumption,
                voltage: parseFloatOrNull($(this).find(".voltage").val()),
                ampere: parseFloatOrNull($(this).find(".ampere").val()),
                powerFactor: parseFloatOrNull($(this).find(".pf").val()),
                frequency: parseFloatOrNull($(this).find(".freq").val())
            });
        });

        return { meterSerialNo, year, month, readings };
    }

    function saveSingleDay($tr){
        const payload = collectRowsData($tr);
        const $btn = $tr.find(".save-day");
        $btn.prop("disabled", true).text("Saving...");

        $.ajax({
            url: `${apiMeterReadingsBase}/meter/${encodeURIComponent(meterSerialNo)}/bulk?year=${payload.year}&month=${payload.month}`,
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify(payload),
            success: () => loadCalendar(),
            error: xhr => alert("Error saving: " + (xhr.responseJSON?.message || xhr.responseText || xhr.statusText)),
            complete: () => $btn.prop("disabled", false).html('<i class="bi bi-save"></i> Save')
        });
    }

    function bulkSave(){
        const payload = collectRowsData();
        if(payload.readings.length === 0) return alert("No readings to save.");

        $("#bulkSaveBtn").prop("disabled", true).text("Saving...");

        $.ajax({
            url: `${apiMeterReadingsBase}/meter/${encodeURIComponent(meterSerialNo)}/bulk?year=${payload.year}&month=${payload.month}`,
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify(payload),
            success: () => { alert("Saved successfully."); loadCalendar(); },
            error: xhr => alert("Error saving: " + (xhr.responseJSON?.message || xhr.responseText || xhr.statusText)),
            complete: () => $("#bulkSaveBtn").prop("disabled", false).html('<i class="bi bi-save"></i> Save All')
        });
    }

    function generateBill(){
        const year = $("#year").val();
        const month = $("#month").val();

        $.get(`${apiMeterReadingsBase}/meter/${encodeURIComponent(meterSerialNo)}/monthly?year=${year}&month=${month}`)
            .done(monthly => alert(`Monthly total for ${month}/${year}: ${monthly.totalConsumptionKwh} kWh`))
            .fail(() => alert("Error fetching monthly total."));
    }

    function parseFloatOrNull(v){
        const n = parseFloat(v);
        return isNaN(n) ? null : n;
    }
</script>
