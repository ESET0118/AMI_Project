@{
    ViewBag.Title = "Meter Readings";
    var serialNo = ViewBag.SerialNo as string;
}

<!-- Container -->
<div class="container d-flex justify-content-center align-items-center min-vh-100">
    <div class="row justify-content-center" id="readingsContainer" style="max-width: 1000px; width: 100%;">
        <div class="col-12 text-center" id="loadingMessage">Loading meter readings...</div>
    </div>
</div>

<!-- Pay Bill Modal -->
<div class="modal fade" id="payBillModal" tabindex="-1" aria-labelledby="payBillModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header border-0">
                <h5 class="modal-title" id="payBillModalLabel">Pay Meter Bill</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p id="modalMeterInfo"></p>
                <label for="amountInput" class="form-label">Enter amount to pay:</label>
                <input type="number" id="amountInput" class="form-control" placeholder="0.00" min="0" step="0.01">
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-gradient" id="confirmPayBtn">Pay Now</button>
            </div>
        </div>
    </div>
</div>

<!-- Scripts -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"></script>

<script>
    const apiReadingsBase = "https://localhost:7199/api/MeterReading"; // Replace with your API URL
    const serialNo = '@serialNo';

    function loadMeterReadings(serialNo) {
        const url = `${apiReadingsBase}/meter/${serialNo}`;
        $("#readingsContainer").html('<div class="col-12 text-center" id="loadingMessage">Loading readings...</div>');

        $.get(url)
            .done(data => {
                if (!data || data.length === 0) {
                    $("#readingsContainer").html('<div class="col-12 text-center text-muted">No readings found.</div>');
                    return;
                }

                const cards = data.map(r => `
                    <div class="col-md-6 mb-4">
                        <div class="card reading-card h-100 text-light">
                            <div class="card-body">
                                <h3 class="card-title mb-3">Reading #${r.meterReadingId}</h3>
                                <p><strong>Serial No:</strong> ${r.meterSerialNo}</p>
                                <p><strong>Reading Date:</strong> ${new Date(r.readingDateTime).toLocaleString()}</p>
                                <p><strong>Consumption:</strong> ${r.consumptionKwh} kWh</p>
                                <p><strong>Voltage:</strong> ${r.voltage ?? '-'}</p>
                                <p><strong>Ampere:</strong> ${r.ampere ?? '-'}</p>
                                <p><strong>Power Factor:</strong> ${r.powerFactor ?? '-'}</p>
                                <p><strong>Frequency:</strong> ${r.frequency ?? '-'}</p>
                                <p class="text-muted small">Created at: ${new Date(r.createdAt).toLocaleString()}</p>
                            </div>
                            <div class="card-footer text-center bg-dark-transparent">
                                <button class="btn btn-gradient payBillBtn" data-id="${r.meterReadingId}" data-serial="${r.meterSerialNo}">Pay Bill</button>
                            </div>
                        </div>
                    </div>
                `).join('');

                $("#readingsContainer").html(cards);
            })
            .fail(() => {
                $("#readingsContainer").html('<div class="col-12 text-center text-danger">Failed to load readings.</div>');
            });
    }

    // Pay Bill Button Click -> Open Modal
    $(document).on("click", ".payBillBtn", function () {
        const serialNo = $(this).data("serial");
        const readingId = $(this).data("id");
        $("#modalMeterInfo").text(`Pay bill for Meter: ${serialNo}, Reading #${readingId}`);
        $("#amountInput").val('');
        const payModal = new bootstrap.Modal(document.getElementById('payBillModal'));
        payModal.show();
    });

    // Confirm Payment
    $("#confirmPayBtn").on("click", function () {
        const amount = $("#amountInput").val();
        if (!amount || amount <= 0) {
            alert("Please enter a valid amount.");
            return;
        }
        alert(`Payment of $${amount} submitted!`);
        const payModalEl = document.getElementById('payBillModal');
        const modalInstance = bootstrap.Modal.getInstance(payModalEl);
        modalInstance.hide();
    });

    $(document).ready(() => {
        loadMeterReadings(serialNo);
    });
</script>

<style>
    body {
        background-color: #121212;
        color: #ffffff;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    /* Container fixes */
    #readingsContainer {
        max-width: 1000px;
        width: 100%;
        margin: auto;
    }

    /* Card styles */
    .reading-card {
        width: 100%; /* full width of the column */
        background: linear-gradient(145deg, #1f1f1f, #292929);
        border-radius: 20px;
        box-shadow: 0 15px 30px rgba(0, 0, 0, 0.7);
        padding: 25px;
        transition: transform 0.3s, box-shadow 0.3s;
        font-size: 1rem;
        line-height: 1.6;
        word-wrap: break-word; /* prevent mid-word breaks */
    }

        .reading-card h3 {
            font-size: 1.5rem;
        }

        .reading-card p {
            font-size: 1rem;
        }

        /* Card hover effect */
        .reading-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.8);
        }

    /* Card footer transparent */
    .bg-dark-transparent {
        background-color: rgba(30, 30, 30, 0.8);
        border-top: 1px solid rgba(255, 255, 255, 0.1);
        padding: 15px;
    }

    /* Gradient button */
    .btn-gradient {
        background: linear-gradient(135deg, #6a11cb, #2575fc);
        border: none;
        color: #fff;
        padding: 12px 30px;
        font-weight: 600;
        font-size: 1rem;
        border-radius: 50px;
        transition: all 0.3s ease;
        cursor: pointer;
    }

        .btn-gradient:hover {
            background: linear-gradient(135deg, #2575fc, #6a11cb);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5);
        }

    /* Modal Input */
    .modal-content input {
        border-radius: 10px;
        padding: 10px;
        border: none;
    }

    /* Responsive Bootstrap column fix */
    @@media (min-width: 768px) {
        .col-md-6

    {
        flex: 0 0 50%;
        max-width: 50%;
    }

    }

    @@media (max-width: 767px) {
        .col-md-6

    {
        max-width: 100%;
    }

    }
</style>
