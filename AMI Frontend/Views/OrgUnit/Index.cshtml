@{
    ViewBag.Title = "Org Unit Hierarchy";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h4 class="fw-bold text-dark">
            <i class="bi bi-diagram-3 text-primary"></i> Org Unit Hierarchy
        </h4>
        <div class="d-flex gap-2">
            <button id="clearAllBtn" class="btn btn-outline-secondary">
                <i class="bi bi-eraser"></i> Clear Selections
            </button>
            <button id="addOrgUnitBtn" class="btn btn-primary shadow-sm">
                <i class="bi bi-plus-circle"></i> Add Org Unit
            </button>
        </div>
    </div>

    <div class="card shadow-lg border-0 rounded-4 glass-card">
        <div class="card-body">
            <div class="row g-3 mb-4">
                <div class="col-md-3">
                    <label class="fw-semibold">Zone</label>
                    <select id="zoneSelect" class="form-select">
                        <option value="">-- Select Zone --</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="fw-semibold">Substation</label>
                    <select id="substationSelect" class="form-select" disabled>
                        <option value="">-- Select Substation --</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="fw-semibold">Feeder</label>
                    <select id="feederSelect" class="form-select" disabled>
                        <option value="">-- Select Feeder --</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="fw-semibold">DTR</label>
                    <select id="dtrSelect" class="form-select" disabled>
                        <option value="">-- Select DTR --</option>
                    </select>
                </div>
            </div>

            <div class="mb-4">
                <label class="fw-semibold">Select DTR Directly</label>
                <select id="dtrDirectSelect" class="form-select w-50">
                    <option value="">-- Select DTR --</option>
                </select>
            </div>

            <div class="mt-4">
                <h6 class="fw-bold">
                    <i class="bi bi-link-45deg text-primary"></i> Selected Hierarchy:
                </h6>
                <p id="selectedHierarchy" class="text-muted">None selected</p>
            </div>

            <div id="actionButtons" class="mt-4" style="display:none;">
                <button id="editBtn" class="btn btn-warning me-2">
                    <i class="bi bi-pencil-square"></i> Edit
                </button>
                <button id="deleteBtn" class="btn btn-danger">
                    <i class="bi bi-trash"></i> Delete
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal -->
<div class="modal fade" id="addOrgUnitModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content rounded-4 shadow">
            <div class="modal-header text-white" style="background: linear-gradient(90deg, #0078ff, #00d084);">
                <h5 class="modal-title fw-bold">Add / Edit Org Unit</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body bg-light bg-gradient">
                <form id="orgUnitForm">
                    <input type="hidden" id="orgUnitId" />
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Name</label>
                            <input type="text" class="form-control" id="orgUnitName" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Type</label>
                            <select class="form-select" id="orgUnitType" required>
                                <option value="">Select Type</option>
                                <option value="Zone">Zone</option>
                                <option value="Substation">Substation</option>
                                <option value="Feeder">Feeder</option>
                                <option value="DTR">DTR</option>
                            </select>
                        </div>
                        <div class="col-md-12">
                            <label class="form-label">Parent (Optional)</label>
                            <select class="form-select" id="orgUnitParent"></select>
                        </div>
                    </div>
                    <div class="text-end mt-4">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-circle me-1"></i> Save
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    const apiBase = "https://localhost:7199/api/orgunit";
    let allUnits = [];
    let selectedUnitId = null;

    $(document).ready(async function () {
        await loadAllUnits();
        populateZones();
        populateDTRDirect();
        setupHandlers();
    });

    // 🔹 Load all OrgUnits once
    async function loadAllUnits() {
        try {
            allUnits = await $.get(apiBase);
        } catch (e) {
            console.error("Failed to load OrgUnits", e);
        }
    }

    // 🔹 Populate dropdowns
    function populateZones() {
        const zones = allUnits.filter(u => u.type === "Zone");
        fillSelect("#zoneSelect", zones, "Zone");
    }

    function populateDTRDirect() {
        const dtrs = allUnits.filter(u => u.type === "DTR");
        fillSelect("#dtrDirectSelect", dtrs, "DTR");
    }

    function fillSelect(selector, list, label) {
        const sel = $(selector);
        sel.empty().append(`<option value="">-- Select ${label} --</option>`);
        list.forEach(u => sel.append(`<option value="${u.orgUnitId}">${u.name}</option>`));
        sel.prop("disabled", list.length === 0);
    }

    // 🔹 Set up cascade logic
    function setupHandlers() {
        // Zone → Substation
        $("#zoneSelect").change(function () {
            const zoneId = $(this).val();
            clearBelow("#substationSelect");
            if (!zoneId) return updateHierarchy();

            const subs = allUnits.filter(u => u.type === "Substation" && u.parentId == zoneId);
            fillSelect("#substationSelect", subs, "Substation");
            updateHierarchy();
        });

        // Substation → Feeder
        $("#substationSelect").change(function () {
            const subId = $(this).val();
            clearBelow("#feederSelect");
            if (!subId) return updateHierarchy();

            const feeders = allUnits.filter(u => u.type === "Feeder" && u.parentId == subId);
            fillSelect("#feederSelect", feeders, "Feeder");
            updateHierarchy();
        });

        // Feeder → DTR
        $("#feederSelect").change(function () {
            const feederId = $(this).val();
            clearBelow("#dtrSelect");
            if (!feederId) return updateHierarchy();

            const dtrs = allUnits.filter(u => u.type === "DTR" && u.parentId == feederId);
            fillSelect("#dtrSelect", dtrs, "DTR");
            updateHierarchy();
        });

        // DTR (cascade or direct)
        $("#dtrSelect, #dtrDirectSelect").change(function () {
            selectedUnitId = $(this).val();
            updateHierarchy();
            toggleActionButtons();
        });

        // Clear all
        $("#clearAllBtn").click(function () {
            $("select").val("").prop("disabled", false);
            $("#selectedHierarchy").text("None selected");
            $("#actionButtons").hide();
        });

        // Add
        $("#addOrgUnitBtn").click(function () {
            clearForm();
            populateParentDropdown();
            $("#addOrgUnitModal").modal("show");
        });

        // Edit
        $("#editBtn").click(function () {
            if (!selectedUnitId) return alert("Select a unit to edit.");
            const unit = allUnits.find(u => u.orgUnitId == selectedUnitId);
            if (!unit) return;

            $("#orgUnitId").val(unit.orgUnitId);
            $("#orgUnitName").val(unit.name);
            $("#orgUnitType").val(unit.type);
            $("#orgUnitParent").val(unit.parentId || "");
            populateParentDropdown();
            $("#addOrgUnitModal").modal("show");
        });

        // Delete
        $("#deleteBtn").click(async function () {
            if (!selectedUnitId) return alert("Select a unit to delete.");
            if (confirm("Are you sure you want to delete this Org Unit?")) {
                await $.ajax({ url: `${apiBase}/${selectedUnitId}`, type: "DELETE" });
                alert("Deleted successfully!");
                location.reload();
            }
        });

        // Save form (Add/Edit)
        $("#orgUnitForm").submit(async function (e) {
            e.preventDefault();
            const id = $("#orgUnitId").val();
            const dto = {
                name: $("#orgUnitName").val(),
                type: $("#orgUnitType").val(),
                parentId: $("#orgUnitParent").val() || null
            };

            const options = {
                url: id ? `${apiBase}/${id}` : apiBase,
                type: id ? "PUT" : "POST",
                data: JSON.stringify(dto),
                contentType: "application/json"
            };
            await $.ajax(options);
            alert(id ? "Updated successfully!" : "Added successfully!");
            $("#addOrgUnitModal").modal("hide");
            location.reload();
        });
    }

    // 🔹 Populate possible parent list
    function populateParentDropdown() {
        const parents = allUnits.map(u => `<option value="${u.orgUnitId}">${u.name} (${u.type})</option>`).join("");
        $("#orgUnitParent").html(`<option value="">-- None --</option>${parents}`);
    }

    // 🔹 Clear all dropdowns below
    function clearBelow(selector) {
        const toClear = {
            "#substationSelect": ["#substationSelect", "#feederSelect", "#dtrSelect"],
            "#feederSelect": ["#feederSelect", "#dtrSelect"],
            "#dtrSelect": ["#dtrSelect"]
        }[selector];

        toClear?.forEach(sel => $(sel).empty().prop("disabled", true));
    }

    // 🔹 Update displayed hierarchy
    function updateHierarchy() {
        const zone = $("#zoneSelect option:selected").text();
        const sub = $("#substationSelect option:selected").text();
        const feeder = $("#feederSelect option:selected").text();
        const dtr = $("#dtrSelect option:selected").text();

        const hierarchy = [zone, sub, feeder, dtr]
            .filter(x => x && !x.includes("Select"))
            .join(" → ");
        $("#selectedHierarchy").text(hierarchy || "None selected");
    }

    // 🔹 Show/hide edit/delete buttons
    function toggleActionButtons() {
        if (selectedUnitId) $("#actionButtons").show();
        else $("#actionButtons").hide();
    }

    function clearForm() {
        $("#orgUnitId, #orgUnitName, #orgUnitType, #orgUnitParent").val("");
    }
</script>

