@{
    ViewBag.Title = "Meter Readings";
    var serialNo = ViewBag.SerialNo as string;
}

<div class="container d-flex justify-content-center align-items-center min-vh-100">
    <div class="row justify-content-center" id="readingsContainer" style="max-width: 1000px; width: 100%;">
        <div class="col-12 text-center" id="loadingMessage">Loading meter readings...</div>
    </div>
</div>

<!-- Pay Bill Modal -->
<div class="modal fade" id="payBillModal" tabindex="-1" aria-labelledby="payBillModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-dark text-light rounded-4">
            <div class="modal-header border-0">
                <h5 class="modal-title" id="payBillModalLabel">Pay Meter Bill</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body text-center">
                <p id="modalMeterInfo" class="mb-2"></p>
                <p><strong>Bill Amount:</strong> $<span id="modalBillAmount">0.00</span></p>

                <hr class="border-secondary">

                <!-- UPI Payment Info -->
                <p class="fw-bold mb-1">Scan to Pay</p>
                <img src="C:\Users\HP\Desktop\AMI\AMI Frontend\images\QR.jpg" alt="UPI QR" class="rounded mb-3" style="max-width: 200px;">

                <p class="text-muted small mb-1">or pay using UPI ID:</p>
                <p class="fw-semibold text-info mb-3" id="vpaText">prakritishghosh29@okhdfcbank</p>

                <button class="btn btn-outline-info btn-sm copyVpaBtn">
                    Copy VPA
                </button>

                <div class="mt-3">
                    <a id="upiPayLink" target="_blank" class="btn btn-gradient mt-3">
                        Pay via UPI App
                    </a>
                </div>
            </div>

            <div class="modal-footer border-0">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>


<!-- Scripts -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"></script>

<script>
        const apiReadingsBase = "https://localhost:7199/api/MeterReading";
    const apiBillingBase = "https://localhost:7199/api/Bill"; // your controller is /api/Bill
    const serialNo = '@serialNo';

    async function loadMeterReadings(serialNo) {
        $("#readingsContainer").html('<div class="col-12 text-center">Loading readings...</div>');

        try {
            // 1️⃣ Fetch all readings for this meter
            const readings = await $.get(`${apiReadingsBase}/meter/${serialNo}`);

            if (!readings || readings.length === 0) {
                $("#readingsContainer").html('<div class="col-12 text-center text-muted">No readings found.</div>');
                return;
            }

            // 2️⃣ Fetch bill for this meter
            let billAmount = 0;
            try {
                const billResp = await $.get(`${apiBillingBase}/${serialNo}`);
                billAmount = billResp.billAmount ?? 0;
            } catch {
                billAmount = 0;
            }

            // 3️⃣ Build cards
            const cardsHtml = readings.map(r => `
                <div class="col-md-6 mb-4">
                    <div class="card reading-card h-100 text-light">
                        <div class="card-body">
                            <h3 class="card-title mb-3">Reading #${r.meterReadingId}</h3>
                            <p><strong>Serial No:</strong> ${r.meterSerialNo}</p>
                            <p><strong>Reading Date:</strong> ${new Date(r.readingDateTime).toLocaleString()}</p>
                            <p><strong>Consumption:</strong> ${r.consumptionKwh} kWh</p>
                            <p><strong>Voltage:</strong> ${r.voltage ?? '-'}</p>
                            <p><strong>Ampere:</strong> ${r.ampere ?? '-'}</p>
                            <p><strong>Power Factor:</strong> ${r.powerFactor ?? '-'}</p>
                            <p><strong>Frequency:</strong> ${r.frequency ?? '-'}</p>
                            <p><strong>Total Bill Amount:</strong> $${billAmount.toFixed(2)}</p>
                            <p class="text-muted small">Created at: ${new Date(r.createdAt).toLocaleString()}</p>
                        </div>
                        <div class="card-footer text-center bg-dark-transparent">
                            <button class="btn btn-gradient payBillBtn"
                                data-serial="${r.meterSerialNo}"
                                data-amount="${billAmount.toFixed(2)}">
                                Pay Bill
                            </button>
                        </div>
                    </div>
                </div>
            `);

            $("#readingsContainer").html(cardsHtml.join(''));
        } catch {
            $("#readingsContainer").html('<div class="col-12 text-center text-danger">Failed to load readings.</div>');
        }
    }

    // Pay Bill Modal
    $(document).on("click", ".payBillBtn", function () {
        const serialNo = $(this).data("serial");
        const amount = $(this).data("amount");

        // Your UPI details
        const vpa = "prakritishghosh29@okhdfcbank";
        const name = "Prakritish Ghosh";
        const note = `Meter bill for ${serialNo}`;
        const upiLink = `upi://pay?pa=${encodeURIComponent(vpa)}&pn=${encodeURIComponent(name)}&am=${amount}&cu=INR&tn=${encodeURIComponent(note)}`;

        $("#modalMeterInfo").text(`Pay bill for Meter: ${serialNo}`);
        $("#modalBillAmount").text(amount);
        $("#vpaText").text(vpa);
        $("#upiPayLink").attr("href", upiLink);

        const payModal = new bootstrap.Modal(document.getElementById('payBillModal'));
        payModal.show();
    });

    // Copy VPA button
    $(document).on("click", ".copyVpaBtn", function () {
        const vpa = $("#vpaText").text();
        navigator.clipboard.writeText(vpa);
        $(this).text("Copied! ✅");
        setTimeout(() => $(this).text("Copy VPA"), 1500);
    });



    // Confirm Payment
    $("#confirmPayBtn").on("click", function () {
        const amount = $("#modalBillAmount").text();
        alert(`Payment of $${amount} submitted!`);
        const payModalEl = document.getElementById('payBillModal');
        const modalInstance = bootstrap.Modal.getInstance(payModalEl);
        modalInstance.hide();
    });

    $(document).ready(() => {
        loadMeterReadings(serialNo);
    });

</script>

<style>
    body {
        background-color: #121212;
        color: #fff;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    #readingsContainer {
        max-width: 1000px;
        width: 100%;
        margin: auto;
    }

    .reading-card {
        width: 100%;
        background: linear-gradient(145deg, #1f1f1f, #292929);
        border-radius: 20px;
        box-shadow: 0 15px 30px rgba(0,0,0,0.7);
        padding: 25px;
        transition: transform 0.3s, box-shadow 0.3s;
        font-size: 1rem;
        line-height: 1.6;
        word-wrap: break-word;
    }

        .reading-card h3 {
            font-size: 1.5rem;
        }

        .reading-card p {
            font-size: 1rem;
        }

        .reading-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.8);
        }

    .bg-dark-transparent {
        background-color: rgba(30,30,30,0.8);
        border-top: 1px solid rgba(255,255,255,0.1);
        padding: 15px;
    }

    .btn-gradient {
        background: linear-gradient(135deg, #6a11cb,#2575fc);
        border: none;
        color: #fff;
        padding: 12px 30px;
        font-weight: 600;
        font-size: 1rem;
        border-radius: 50px;
        transition: all 0.3s ease;
        cursor: pointer;
    }

        .btn-gradient:hover {
            background: linear-gradient(135deg, #2575fc,#6a11cb);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.5);
        }

    .modal-content input {
        border-radius: 10px;
        padding: 10px;
        border: none;
    }

    .modal-body img {
        border: 3px solid rgba(255,255,255,0.1);
        box-shadow: 0 0 15px rgba(0,0,0,0.6);
    }

    .btn-outline-info {
        border-radius: 30px;
        font-weight: 600;
    }

    @@media (min-width: 768px) {
        .col-md-6

    {
        flex: 0 0 50%;
        max-width: 50%;
    }

    }
    @@media (max-width: 767px) {
        .col-md-6

    {
        max-width: 100%;
    }

    }
</style>
